@page "/accounts"
@using BankingApp.Models
@using BankingApp.Services
@using BankingApp.Components
@inject IAccountService AccountService

<AuthenticationRequired>
    <h3 class="mb-3">Bankkonton</h3>

<div class="card p-3 mb-4 shadow-sm">
    <h5>Skapa nytt konto</h5>

    <div class="row g-2">
        <div class="col-md-4">
            <input @bind="newAccountName" class="form-control" placeholder="Kontonamn" />
        </div>

        <div class="col-md-3">
            <select @bind="selectedType" class="form-select">
                <option value="">-- V채lj kontotyp --</option>
                @foreach (var type in Enum.GetValues<AccountType>())
                {
                    <option value="@type">@type</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <select @bind="selectedCurrency" class="form-select">
                <option value="SEK">SEK</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
            </select>
        </div>

        <div class="col-md-3">
            <button class="btn btn-primary w-100" @onclick="CreateAccount">Skapa konto</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="text-danger mt-2">@errorMessage</div>
    }
</div>

@if (accounts.Any())
{
    <table class="table table-striped table-hover shadow-sm">
        <thead class="table-light">
            <tr>
                <th>Kontonamn</th>
                <th>Typ</th>
                <th>Valuta</th>
                <th>Saldo</th>
                <th>Kontonummer</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var acc in accounts)
            {
                <tr>
                    <td>@acc.AccountName</td>
                    <td>@acc.AccountType</td>
                    <td>@acc.Valuta</td>
                    <td>@acc.Balance.ToString("N2")</td>
                    <td>@acc.AccountNumber</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-muted fst-italic">Inga konton skapade 채nnu.</p>
}

@code {
    private List<BankAccount> accounts = new();
    private string newAccountName = string.Empty;
    private string selectedCurrency = "SEK";
    private AccountType? selectedType;
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        // Try to fetch existing accounts from AccountService
        accounts = typeof(AccountService)
            .GetField("_accounts", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)?
            .GetValue(AccountService) as List<BankAccount> ?? new List<BankAccount>();
    }

    private void CreateAccount()
    {
        errorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(newAccountName) || selectedType is null)
        {
            errorMessage = "V채nligen fyll i alla f채lt.";
            return;
        }

        AccountService.CreateAccount(newAccountName, selectedType.ToString()!, selectedCurrency);
        newAccountName = string.Empty;
        selectedType = null;
        selectedCurrency = "SEK";

        // Update table (would reload from service in real app)
        accounts = typeof(AccountService)
            .GetField("_accounts", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)?
            .GetValue(AccountService) as List<BankAccount> ?? new List<BankAccount>();
    }
}
</AuthenticationRequired>
