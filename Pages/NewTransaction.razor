@page "/transactions"
@using BankingApp.Models
@using BankingApp.Services
@inject IAccountService AccountService

<h3 class="mb-3">Ny transaktion</h3>

@if (accounts.Count == 0)
{
    <p class="text-muted fst-italic">Inga konton hittades. Skapa ett konto först.</p>
}
else
{
    <div class="card p-3 shadow-sm mb-4">
        <h5>Välj konto och transaktionstyp</h5>

        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Från konto</label>
                <select class="form-select" @bind="selectedAccountId">
                    <option value="">-- Välj konto --</option>
                    @for (int i = 0; i < accounts.Count; i++)
                    {
                        <option value="@i">@accounts[i].AccountName (@accounts[i].Balance.ToString("N2") @accounts[i].Valuta)</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Transaktionstyp</label>
                <select class="form-select" @bind="transactionType">
                    <option value="">-- Välj typ --</option>
                    <option value="Deposit">Insättning</option>
                    <option value="Withdraw">Uttag</option>
                    <option value="Transfer">Överföring</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Belopp</label>
                <input type="number" min="1" step="0.01" class="form-control" @bind="amount" />
            </div>

            @if (transactionType == "Transfer")
            {
                <div class="col-md-3">
                    <label class="form-label">Till konto</label>
                    <select class="form-select" @bind="toAccountId">
                        <option value="">-- Välj konto --</option>
                        @for (int i = 0; i < accounts.Count; i++)
                        {
                            <option value="@i">@accounts[i].AccountName</option>
                        }
                    </select>
                </div>
            }
        </div>

        <div class="mt-3">
            <button class="btn btn-success me-2" @onclick="ExecuteTransaction">Utför transaktion</button>
            <button class="btn btn-secondary" @onclick="ClearForm">Rensa</button>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="mt-3 @(isError ? "text-danger" : "text-success")">
                @message
            </div>
        }
    </div>
}

@code {
    private List<BankAccount> accounts = new();
    private string selectedAccountId = string.Empty;
    private string? toAccountId;
    private string transactionType = string.Empty;
    private decimal amount;
    private string message = string.Empty;
    private bool isError = false;

    protected override void OnInitialized()
    {
        accounts = typeof(AccountService)
            .GetField("_accounts", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)?
            .GetValue(AccountService) as List<BankAccount> ?? new List<BankAccount>();
    }

    private void ExecuteTransaction()
    {
        message = string.Empty;
        isError = false;

        if (string.IsNullOrEmpty(selectedAccountId) || amount <= 0 || string.IsNullOrEmpty(transactionType))
        {
            message = "Vänligen fyll i alla obligatoriska fält.";
            isError = true;
            return;
        }

        try
        {
            int fromId = int.Parse(selectedAccountId);

            switch (transactionType)
            {
                case "Deposit":
                    AccountService.Deposit(fromId, amount);
                    message = $"Insättning på {amount:N2} SEK genomförd.";
                    break;

                case "Withdraw":
                    AccountService.Withdraw(fromId, amount);
                    message = $"Uttag på {amount:N2} SEK genomfört.";
                    break;

                case "Transfer":
                    if (string.IsNullOrEmpty(toAccountId))
                    {
                        message = "Välj mottagarkonto.";
                        isError = true;
                        return;
                    }
                    int toId = int.Parse(toAccountId);
                    AccountService.TransferFunds(fromId, toId, amount);
                    message = $"Överföring på {amount:N2} SEK från {accounts[fromId].AccountName} till {accounts[toId].AccountName} genomförd.";
                    break;
            }

            ClearForm();
        }
        catch (Exception ex)
        {
            message = ex.Message;
            isError = true;
        }
    }

    private void ClearForm()
    {
        selectedAccountId = string.Empty;
        toAccountId = null;
        transactionType = string.Empty;
        amount = 0;
    }
}
